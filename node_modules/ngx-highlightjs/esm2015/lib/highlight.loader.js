import { Injectable, Inject, PLATFORM_ID, Optional } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { BehaviorSubject, from, EMPTY, zip, throwError } from 'rxjs';
import { catchError, tap, map, switchMap, filter, take } from 'rxjs/operators';
import { HIGHLIGHT_OPTIONS } from './highlight.model';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "./highlight.model";
// @dynamic
import * as ɵngcc0 from '@angular/core';
export class HighlightLoader {
    constructor(doc, platformId, _options) {
        this._options = _options;
        // Stream that emits when hljs library is loaded and ready to use
        this._ready = new BehaviorSubject(null);
        this.ready = this._ready.asObservable().pipe(filter((hljs) => !!hljs), map((hljs) => hljs), take(1));
        // Check if hljs is already available
        if (isPlatformBrowser(platformId) && doc.defaultView.hljs) {
            this._ready.next(doc.defaultView.hljs);
        }
        else {
            // Load hljs library
            this._loadLibrary().pipe(switchMap((hljs) => {
                if (this._options && this._options.lineNumbersLoader) {
                    // Make hljs available on window object (required for the line numbers library)
                    doc.defaultView.hljs = hljs;
                    // Load line numbers library
                    return this.loadLineNumbers().pipe(tap(() => this._ready.next(hljs)));
                }
                else {
                    this._ready.next(hljs);
                    return EMPTY;
                }
            }), catchError((e) => {
                console.error('[HLJS] ', e);
                return EMPTY;
            })).subscribe();
        }
    }
    /**
     * Lazy-Load highlight.js library
     */
    _loadLibrary() {
        if (this._options) {
            if (this._options.fullLibraryLoader && this._options.coreLibraryLoader) {
                return throwError('The full library and the core library were imported, only one of them should be imported!');
            }
            if (this._options.fullLibraryLoader && this._options.languages) {
                return throwError('The highlighting languages were imported they are not needed!');
            }
            if (this._options.coreLibraryLoader && !this._options.languages) {
                return throwError('The highlighting languages were not imported!');
            }
            if (!this._options.coreLibraryLoader && this._options.languages) {
                return throwError('The core library was not imported!');
            }
            if (this._options.fullLibraryLoader) {
                return this.loadFullLibrary();
            }
            if (this._options.coreLibraryLoader && this._options.languages && Object.keys(this._options.languages).length) {
                return this.loadCoreLibrary().pipe(switchMap((hljs) => this._loadLanguages(hljs)));
            }
        }
        return throwError('Highlight.js library was not imported!');
    }
    /**
     * Lazy-load highlight.js languages
     */
    _loadLanguages(hljs) {
        const languages = Object.entries(this._options.languages).map(([langName, langLoader]) => importModule(langLoader()).pipe(tap((langFunc) => hljs.registerLanguage(langName, langFunc))));
        return zip(...languages).pipe(map(() => hljs));
    }
    /**
     * Import highlight.js core library
     */
    loadCoreLibrary() {
        return importModule(this._options.coreLibraryLoader());
    }
    /**
     * Import highlight.js library with all languages
     */
    loadFullLibrary() {
        return importModule(this._options.fullLibraryLoader());
    }
    /**
     * Import line numbers library
     */
    loadLineNumbers() {
        return importModule(this._options.lineNumbersLoader());
    }
}
HighlightLoader.ɵfac = function HighlightLoader_Factory(t) { return new (t || HighlightLoader)(ɵngcc0.ɵɵinject(DOCUMENT), ɵngcc0.ɵɵinject(PLATFORM_ID), ɵngcc0.ɵɵinject(HIGHLIGHT_OPTIONS, 8)); };
HighlightLoader.ɵprov = i0.ɵɵdefineInjectable({ factory: function HighlightLoader_Factory() { return new HighlightLoader(i0.ɵɵinject(i1.DOCUMENT), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i2.HIGHLIGHT_OPTIONS, 8)); }, token: HighlightLoader, providedIn: "root" });
HighlightLoader.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HIGHLIGHT_OPTIONS,] }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(HighlightLoader, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [HIGHLIGHT_OPTIONS]
            }] }]; }, null); })();
/**
 * Map loader response to module object
 */
const importModule = (moduleLoader) => {
    return from(moduleLoader).pipe(filter((module) => !!module && !!module.default), map((module) => module.default));
};
const ɵ0 = importModule;
export { ɵ0 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmxvYWRlci5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcHJvamVjdHMvbmd4LWhpZ2hsaWdodGpzL3NyYy9saWIvaGlnaGxpZ2h0LmxvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZUFBZSxFQUFjLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRixPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMvRSxPQUFPLEVBQUUsaUJBQWlCLEVBQXNDLE1BQU0sbUJBQW1CLENBQUM7QUFDMUY7QUFHVTtBQUVlO0FBSnpCLFdBQVc7O0FBSVgsTUFBTSxPQUFPLGVBQWU7QUFDNUIsSUFRRSxZQUE4QixHQUFRLEVBQ0wsVUFBa0IsRUFDUSxRQUEwQjtBQUN2RixRQUQ2RCxhQUFRLEdBQVIsUUFBUSxDQUFrQjtBQUFDLFFBVnRGLGlFQUFpRTtBQUNuRSxRQUFtQixXQUFNLEdBQUcsSUFBSSxlQUFlLENBQTBCLElBQUksQ0FBQyxDQUFDO0FBQy9FLFFBQVcsVUFBSyxHQUFpQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDLElBQUksQ0FDNUUsTUFBTSxDQUFDLENBQUMsSUFBNkIsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUNqRCxHQUFHLENBQUMsQ0FBQyxJQUE2QixFQUFFLEVBQUUsQ0FBQyxJQUF3QixDQUFDLEVBQ2hFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FDUixDQUFDO0FBQ0os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QUFBSyxRQUMxQixPQUFPLFlBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFrQixFQUFFLENBQUMsQ0FBQztBQUM1RCxJQUFFLENBQUM7QUFDSDtrTUFBQztBQUNELHdRQW5HSztBQUFDO0VBSEwsVUFBVSxTQUFDLGtCQUNWLFVBQVUsRUFBRSxNQUFNLGNBQ25CLHZFQUVlLDRDQVFELE1BQU0sU0FBQyxRQUFRO0FBQVMseUNBQ3hCLE1BQU0sU0FBQyxXQUFXO0FBQVMsNENBQzNCLFFBQVEsWUFBSSxNQUFNLFNBQUMsaUJBQWlCO0FBQVE7Ozs7Ozs7Ozs7Ozs7Ozs7O2tDQUFFO0FBeUY3RDtBQUNBO0FBQ0EsR0FBRztBQUNILE1BQU0sWUFBWSxHQUFHLENBQUMsWUFBMEIsRUFBbUIsRUFBRTtBQUNyRSxJQUFFLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FDNUIsTUFBTSxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQ3JELEdBQUcsQ0FBQyxDQUFDLE1BQVcsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUNyQyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBQ0Y7QUFBeUI7QUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgUExBVEZPUk1fSUQsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBET0NVTUVOVCwgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBmcm9tLCBFTVBUWSwgemlwLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCB0YXAsIG1hcCwgc3dpdGNoTWFwLCBmaWx0ZXIsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBISUdITElHSFRfT1BUSU9OUywgSGlnaGxpZ2h0TGlicmFyeSwgSGlnaGxpZ2h0T3B0aW9ucyB9IGZyb20gJy4vaGlnaGxpZ2h0Lm1vZGVsJztcblxuLy8gQGR5bmFtaWNcbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEhpZ2hsaWdodExvYWRlciB7XG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gaGxqcyBsaWJyYXJ5IGlzIGxvYWRlZCBhbmQgcmVhZHkgdG8gdXNlXG4gIHByaXZhdGUgcmVhZG9ubHkgX3JlYWR5ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxIaWdobGlnaHRMaWJyYXJ5IHwgbnVsbD4obnVsbCk7XG4gIHJlYWRvbmx5IHJlYWR5OiBPYnNlcnZhYmxlPEhpZ2hsaWdodExpYnJhcnk+ID0gdGhpcy5fcmVhZHkuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICBmaWx0ZXIoKGhsanM6IEhpZ2hsaWdodExpYnJhcnkgfCBudWxsKSA9PiAhIWhsanMpLFxuICAgIG1hcCgoaGxqczogSGlnaGxpZ2h0TGlicmFyeSB8IG51bGwpID0+IGhsanMgYXMgSGlnaGxpZ2h0TGlicmFyeSksXG4gICAgdGFrZSgxKVxuICApO1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoRE9DVU1FTlQpIGRvYzogYW55LFxuICAgICAgICAgICAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwbGF0Zm9ybUlkOiBvYmplY3QsXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSElHSExJR0hUX09QVElPTlMpIHByaXZhdGUgX29wdGlvbnM6IEhpZ2hsaWdodE9wdGlvbnMpIHtcbiAgICAvLyBDaGVjayBpZiBobGpzIGlzIGFscmVhZHkgYXZhaWxhYmxlXG4gICAgaWYgKGlzUGxhdGZvcm1Ccm93c2VyKHBsYXRmb3JtSWQpICYmIGRvYy5kZWZhdWx0Vmlldy5obGpzKSB7XG4gICAgICB0aGlzLl9yZWFkeS5uZXh0KGRvYy5kZWZhdWx0Vmlldy5obGpzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gTG9hZCBobGpzIGxpYnJhcnlcbiAgICAgIHRoaXMuX2xvYWRMaWJyYXJ5KCkucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKChobGpzOiBIaWdobGlnaHRMaWJyYXJ5KSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuX29wdGlvbnMgJiYgdGhpcy5fb3B0aW9ucy5saW5lTnVtYmVyc0xvYWRlcikge1xuICAgICAgICAgICAgLy8gTWFrZSBobGpzIGF2YWlsYWJsZSBvbiB3aW5kb3cgb2JqZWN0IChyZXF1aXJlZCBmb3IgdGhlIGxpbmUgbnVtYmVycyBsaWJyYXJ5KVxuICAgICAgICAgICAgZG9jLmRlZmF1bHRWaWV3LmhsanMgPSBobGpzO1xuICAgICAgICAgICAgLy8gTG9hZCBsaW5lIG51bWJlcnMgbGlicmFyeVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9hZExpbmVOdW1iZXJzKCkucGlwZSh0YXAoKCkgPT4gdGhpcy5fcmVhZHkubmV4dChobGpzKSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9yZWFkeS5uZXh0KGhsanMpO1xuICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICAgIGNhdGNoRXJyb3IoKGU6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tITEpTXSAnLCBlKTtcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgIH0pXG4gICAgICApLnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMYXp5LUxvYWQgaGlnaGxpZ2h0LmpzIGxpYnJhcnlcbiAgICovXG4gIHByaXZhdGUgX2xvYWRMaWJyYXJ5KCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKHRoaXMuX29wdGlvbnMpIHtcbiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmZ1bGxMaWJyYXJ5TG9hZGVyICYmIHRoaXMuX29wdGlvbnMuY29yZUxpYnJhcnlMb2FkZXIpIHtcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ1RoZSBmdWxsIGxpYnJhcnkgYW5kIHRoZSBjb3JlIGxpYnJhcnkgd2VyZSBpbXBvcnRlZCwgb25seSBvbmUgb2YgdGhlbSBzaG91bGQgYmUgaW1wb3J0ZWQhJyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fb3B0aW9ucy5mdWxsTGlicmFyeUxvYWRlciAmJiB0aGlzLl9vcHRpb25zLmxhbmd1YWdlcykge1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignVGhlIGhpZ2hsaWdodGluZyBsYW5ndWFnZXMgd2VyZSBpbXBvcnRlZCB0aGV5IGFyZSBub3QgbmVlZGVkIScpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX29wdGlvbnMuY29yZUxpYnJhcnlMb2FkZXIgJiYgIXRoaXMuX29wdGlvbnMubGFuZ3VhZ2VzKSB7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdUaGUgaGlnaGxpZ2h0aW5nIGxhbmd1YWdlcyB3ZXJlIG5vdCBpbXBvcnRlZCEnKTtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5fb3B0aW9ucy5jb3JlTGlicmFyeUxvYWRlciAmJiB0aGlzLl9vcHRpb25zLmxhbmd1YWdlcykge1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignVGhlIGNvcmUgbGlicmFyeSB3YXMgbm90IGltcG9ydGVkIScpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX29wdGlvbnMuZnVsbExpYnJhcnlMb2FkZXIpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZEZ1bGxMaWJyYXJ5KCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fb3B0aW9ucy5jb3JlTGlicmFyeUxvYWRlciAmJiB0aGlzLl9vcHRpb25zLmxhbmd1YWdlcyAmJiBPYmplY3Qua2V5cyh0aGlzLl9vcHRpb25zLmxhbmd1YWdlcykubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRDb3JlTGlicmFyeSgpLnBpcGUoc3dpdGNoTWFwKChobGpzOiBIaWdobGlnaHRMaWJyYXJ5KSA9PiB0aGlzLl9sb2FkTGFuZ3VhZ2VzKGhsanMpKSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aHJvd0Vycm9yKCdIaWdobGlnaHQuanMgbGlicmFyeSB3YXMgbm90IGltcG9ydGVkIScpO1xuICB9XG5cbiAgLyoqXG4gICAqIExhenktbG9hZCBoaWdobGlnaHQuanMgbGFuZ3VhZ2VzXG4gICAqL1xuICBwcml2YXRlIF9sb2FkTGFuZ3VhZ2VzKGhsanM6IEhpZ2hsaWdodExpYnJhcnkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGxhbmd1YWdlcyA9IE9iamVjdC5lbnRyaWVzKHRoaXMuX29wdGlvbnMubGFuZ3VhZ2VzISkubWFwKChbbGFuZ05hbWUsIGxhbmdMb2FkZXJdKSA9PlxuICAgICAgaW1wb3J0TW9kdWxlKGxhbmdMb2FkZXIoKSkucGlwZShcbiAgICAgICAgdGFwKChsYW5nRnVuYzogYW55KSA9PiBobGpzLnJlZ2lzdGVyTGFuZ3VhZ2UobGFuZ05hbWUsIGxhbmdGdW5jKSlcbiAgICAgIClcbiAgICApO1xuICAgIHJldHVybiB6aXAoLi4ubGFuZ3VhZ2VzKS5waXBlKG1hcCgoKSA9PiBobGpzKSk7XG4gIH1cblxuXG4gIC8qKlxuICAgKiBJbXBvcnQgaGlnaGxpZ2h0LmpzIGNvcmUgbGlicmFyeVxuICAgKi9cbiAgcHJpdmF0ZSBsb2FkQ29yZUxpYnJhcnkoKTogT2JzZXJ2YWJsZTxIaWdobGlnaHRMaWJyYXJ5PiB7XG4gICAgcmV0dXJuIGltcG9ydE1vZHVsZSh0aGlzLl9vcHRpb25zLmNvcmVMaWJyYXJ5TG9hZGVyISgpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbXBvcnQgaGlnaGxpZ2h0LmpzIGxpYnJhcnkgd2l0aCBhbGwgbGFuZ3VhZ2VzXG4gICAqL1xuICBwcml2YXRlIGxvYWRGdWxsTGlicmFyeSgpOiBPYnNlcnZhYmxlPEhpZ2hsaWdodExpYnJhcnk+IHtcbiAgICByZXR1cm4gaW1wb3J0TW9kdWxlKHRoaXMuX29wdGlvbnMuZnVsbExpYnJhcnlMb2FkZXIhKCkpO1xuICB9XG5cblxuICAvKipcbiAgICogSW1wb3J0IGxpbmUgbnVtYmVycyBsaWJyYXJ5XG4gICAqL1xuICBwcml2YXRlIGxvYWRMaW5lTnVtYmVycygpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiBpbXBvcnRNb2R1bGUodGhpcy5fb3B0aW9ucy5saW5lTnVtYmVyc0xvYWRlciEoKSk7XG4gIH1cbn1cblxuLyoqXG4gKiBNYXAgbG9hZGVyIHJlc3BvbnNlIHRvIG1vZHVsZSBvYmplY3RcbiAqL1xuY29uc3QgaW1wb3J0TW9kdWxlID0gKG1vZHVsZUxvYWRlcjogUHJvbWlzZTxhbnk+KTogT2JzZXJ2YWJsZTxhbnk+ID0+IHtcbiAgcmV0dXJuIGZyb20obW9kdWxlTG9hZGVyKS5waXBlKFxuICAgIGZpbHRlcigobW9kdWxlOiBhbnkpID0+ICEhbW9kdWxlICYmICEhbW9kdWxlLmRlZmF1bHQpLFxuICAgIG1hcCgobW9kdWxlOiBhbnkpID0+IG1vZHVsZS5kZWZhdWx0KVxuICApO1xufTtcbiJdfQ==