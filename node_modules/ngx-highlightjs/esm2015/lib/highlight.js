import { Directive, Input, Output, Inject, Optional, EventEmitter, ElementRef, SecurityContext } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { animationFrameScheduler } from 'rxjs';
import { HighlightJS } from './highlight.service';
import { HIGHLIGHT_OPTIONS } from './highlight.model';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './highlight.service';
import * as ɵngcc2 from '@angular/platform-browser';
export class Highlight {
    constructor(el, _hljs, _sanitizer, _options) {
        this._hljs = _hljs;
        this._sanitizer = _sanitizer;
        this._options = _options;
        // Stream that emits when code string is highlighted
        this.highlighted = new EventEmitter();
        this._nativeElement = el.nativeElement;
    }
    ngOnChanges(changes) {
        if (this.code &&
            changes.code &&
            typeof changes.code.currentValue !== 'undefined' &&
            changes.code.currentValue !== changes.code.previousValue) {
            this.highlightElement(this.code, this.languages);
        }
    }
    /**
     * Highlighting with language detection and fix markup.
     * @param code Accepts a string with the code to highlight
     * @param languages An optional array of language names and aliases restricting detection to only those languages.
     * The subset can also be set with configure, but the local parameter overrides the option if set.
     */
    highlightElement(code, languages) {
        // Set code text before highlighting
        this.setTextContent(code);
        this._hljs.highlightAuto(code, languages).subscribe((res) => {
            // Set highlighted code
            this.setInnerHTML(res.value);
            // Check if user want to show line numbers
            if (this.lineNumbers && this._options && this._options.lineNumbersLoader) {
                this.addLineNumbers();
            }
            // Forward highlight response to the highlighted output
            this.highlighted.emit(res);
        });
    }
    addLineNumbers() {
        // Clean up line numbers observer
        this.destroyLineNumbersObserver();
        animationFrameScheduler.schedule(() => {
            // Add line numbers
            this._hljs.lineNumbersBlock(this._nativeElement).subscribe();
            // If lines count is 1, the line numbers library will not add numbers
            // Observe changes to add 'hljs-line-numbers' class only when line numbers is added to the code element
            this._lineNumbersObs = new MutationObserver(() => {
                if (this._nativeElement.firstElementChild && this._nativeElement.firstElementChild.tagName.toUpperCase() === 'TABLE') {
                    this._nativeElement.classList.add('hljs-line-numbers');
                }
                this.destroyLineNumbersObserver();
            });
            this._lineNumbersObs.observe(this._nativeElement, { childList: true });
        });
    }
    destroyLineNumbersObserver() {
        if (this._lineNumbersObs) {
            this._lineNumbersObs.disconnect();
            this._lineNumbersObs = null;
        }
    }
    setTextContent(content) {
        animationFrameScheduler.schedule(() => this._nativeElement.textContent = content);
    }
    setInnerHTML(content) {
        animationFrameScheduler.schedule(() => this._nativeElement.innerHTML = this._sanitizer.sanitize(SecurityContext.HTML, content) || '');
    }
}
Highlight.ɵfac = function Highlight_Factory(t) { return new (t || Highlight)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.HighlightJS), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.DomSanitizer), ɵngcc0.ɵɵdirectiveInject(HIGHLIGHT_OPTIONS, 8)); };
Highlight.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: Highlight, selectors: [["", "highlight", ""]], hostVars: 2, hostBindings: function Highlight_HostBindings(rf, ctx) { if (rf & 2) {
        ɵngcc0.ɵɵclassProp("hljs", true);
    } }, inputs: { code: ["highlight", "code"], languages: "languages", lineNumbers: "lineNumbers" }, outputs: { highlighted: "highlighted" }, features: [ɵngcc0.ɵɵNgOnChangesFeature] });
Highlight.ctorParameters = () => [
    { type: ElementRef },
    { type: HighlightJS },
    { type: DomSanitizer },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HIGHLIGHT_OPTIONS,] }] }
];
Highlight.propDecorators = {
    code: [{ type: Input, args: ['highlight',] }],
    languages: [{ type: Input }],
    lineNumbers: [{ type: Input }],
    highlighted: [{ type: Output }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(Highlight, [{
        type: Directive,
        args: [{
                host: {
                    '[class.hljs]': 'true'
                },
                selector: '[highlight]'
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc1.HighlightJS }, { type: ɵngcc2.DomSanitizer }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [HIGHLIGHT_OPTIONS]
            }] }]; }, { highlighted: [{
            type: Output
        }], code: [{
            type: Input,
            args: ['highlight']
        }], languages: [{
            type: Input
        }], lineNumbers: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaGlnaGxpZ2h0anMvc3JjL2xpYi9oaWdobGlnaHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLE1BQU0sRUFDTixRQUFRLEVBR1IsWUFBWSxFQUNaLFVBQVUsRUFDVixlQUFlLEVBQ2hCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxpQkFBaUIsRUFBcUMsTUFBTSxtQkFBbUIsQ0FBQzs7OztBQVF6RixNQUFNLE9BQU8sU0FBUztBQUFHLElBcUJ2QixZQUFZLEVBQWMsRUFDTixLQUFrQixFQUNsQixVQUF3QixFQUNlLFFBQTBCO0FBQ3ZGLFFBSHNCLFVBQUssR0FBTCxLQUFLLENBQWE7QUFBQyxRQUNuQixlQUFVLEdBQVYsVUFBVSxDQUFjO0FBQUMsUUFDYyxhQUFRLEdBQVIsUUFBUSxDQUFrQjtBQUFDLFFBTnRGLG9EQUFvRDtBQUN0RCxRQUFZLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQW1CLENBQUM7QUFDOUQsUUFLSSxJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQyxhQUFhLENBQUM7QUFDM0MsSUFBRSxDQUFDO0FBQ0gsSUFDRSxXQUFXLENBQUMsT0FBc0I7QUFDcEMsUUFBSSxJQUNFLElBQUksQ0FBQyxJQUFJO0FBQ2YsWUFBTSxPQUFPLENBQUMsSUFBSTtBQUNsQixZQUFNLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLEtBQUssV0FBVztBQUN0RCxZQUFNLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxLQUFLLE9BQU8sQ0FBQyxJ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QUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FDOUYsQ0FBQztBQUNOLElBQUUsQ0FBQztBQUNIO3FDQXRHQyxTQUFTLFNBQUMsa0JBQ1QsSUFBSSxFQUFFLHNCQUNKLGNBQWMsRUFBRSxNQUFNLGtCQUN2QixrQkFDRCxRQUFRLEVBQUUsYUFBYSxjQUN4Qjs7OzBMQUNJO0FBQUM7QUFBbUMsWUFkdkMsVUFBVTtBQUNWLFlBSU8sV0FBVztBQUFJLFlBRmYsWUFBWTtBQUFJLDRDQW1DVixRQUFRLFlBQUksTUFBTSxTQUFDLGlCQUFpQjtBQUFRO0FBQUc7QUFDOUQsbUJBaEJHLEtBQUssU0FBQyxXQUFXO0FBQU8sd0JBSXhCLEtBQUs7QUFBSywwQkFHVixLQUFLO0FBQUssMEJBR1YsTUFBTTtBQUFJOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBJbmplY3QsXG4gIE9wdGlvbmFsLFxuICBPbkNoYW5nZXMsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIEV2ZW50RW1pdHRlcixcbiAgRWxlbWVudFJlZixcbiAgU2VjdXJpdHlDb250ZXh0XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRG9tU2FuaXRpemVyIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQgeyBhbmltYXRpb25GcmFtZVNjaGVkdWxlciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSGlnaGxpZ2h0SlMgfSBmcm9tICcuL2hpZ2hsaWdodC5zZXJ2aWNlJztcbmltcG9ydCB7IEhJR0hMSUdIVF9PUFRJT05TLCBIaWdobGlnaHRPcHRpb25zLCBIaWdobGlnaHRSZXN1bHQgfSBmcm9tICcuL2hpZ2hsaWdodC5tb2RlbCc7XG5cbkBEaXJlY3RpdmUoe1xuICBob3N0OiB7XG4gICAgJ1tjbGFzcy5obGpzXSc6ICd0cnVlJ1xuICB9LFxuICBzZWxlY3RvcjogJ1toaWdobGlnaHRdJ1xufSlcbmV4cG9ydCBjbGFzcyBIaWdobGlnaHQgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuXG4gIC8vIEhpZ2hsaWdodGVkIENvZGVcbiAgcHJpdmF0ZSByZWFkb25seSBfbmF0aXZlRWxlbWVudDogSFRNTEVsZW1lbnQ7XG5cbiAgLy8gVGVtcCBvYnNlcnZlciB0byBvYnNlcnZlIHdoZW4gbGluZSBudW1iZXJzIGhhcyBiZWVuIGFkZGVkIHRvIGNvZGUgZWxlbWVudFxuICBwcml2YXRlIF9saW5lTnVtYmVyc09iczogYW55O1xuXG4gIC8vIEhpZ2hsaWdodCBjb2RlIGlucHV0XG4gIEBJbnB1dCgnaGlnaGxpZ2h0JykgY29kZSE6IHN0cmluZztcblxuICAvLyBBbiBvcHRpb25hbCBhcnJheSBvZiBsYW5ndWFnZSBuYW1lcyBhbmQgYWxpYXNlcyByZXN0cmljdGluZyBkZXRlY3Rpb24gdG8gb25seSB0aG9zZSBsYW5ndWFnZXMuXG4gIC8vIFRoZSBzdWJzZXQgY2FuIGFsc28gYmUgc2V0IHdpdGggY29uZmlndXJlLCBidXQgdGhlIGxvY2FsIHBhcmFtZXRlciBvdmVycmlkZXMgdGhlIG9wdGlvbiBpZiBzZXQuXG4gIEBJbnB1dCgpIGxhbmd1YWdlcyE6IHN0cmluZ1tdO1xuXG4gIC8vIFNob3cgbGluZSBudW1iZXJzXG4gIEBJbnB1dCgpIGxpbmVOdW1iZXJzITogYm9vbGVhbjtcblxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGNvZGUgc3RyaW5nIGlzIGhpZ2hsaWdodGVkXG4gIEBPdXRwdXQoKSBoaWdobGlnaHRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8SGlnaGxpZ2h0UmVzdWx0PigpO1xuXG4gIGNvbnN0cnVjdG9yKGVsOiBFbGVtZW50UmVmLFxuICAgICAgICAgICAgICBwcml2YXRlIF9obGpzOiBIaWdobGlnaHRKUyxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfc2FuaXRpemVyOiBEb21TYW5pdGl6ZXIsXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSElHSExJR0hUX09QVElPTlMpIHByaXZhdGUgX29wdGlvbnM6IEhpZ2hsaWdodE9wdGlvbnMpIHtcbiAgICB0aGlzLl9uYXRpdmVFbGVtZW50ID0gZWwubmF0aXZlRWxlbWVudDtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLmNvZGUgJiZcbiAgICAgIGNoYW5nZXMuY29kZSAmJlxuICAgICAgdHlwZW9mIGNoYW5nZXMuY29kZS5jdXJyZW50VmFsdWUgIT09ICd1bmRlZmluZWQnICYmXG4gICAgICBjaGFuZ2VzLmNvZGUuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLmNvZGUucHJldmlvdXNWYWx1ZVxuICAgICkge1xuICAgICAgdGhpcy5oaWdobGlnaHRFbGVtZW50KHRoaXMuY29kZSwgdGhpcy5sYW5ndWFnZXMpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBIaWdobGlnaHRpbmcgd2l0aCBsYW5ndWFnZSBkZXRlY3Rpb24gYW5kIGZpeCBtYXJrdXAuXG4gICAqIEBwYXJhbSBjb2RlIEFjY2VwdHMgYSBzdHJpbmcgd2l0aCB0aGUgY29kZSB0byBoaWdobGlnaHRcbiAgICogQHBhcmFtIGxhbmd1YWdlcyBBbiBvcHRpb25hbCBhcnJheSBvZiBsYW5ndWFnZSBuYW1lcyBhbmQgYWxpYXNlcyByZXN0cmljdGluZyBkZXRlY3Rpb24gdG8gb25seSB0aG9zZSBsYW5ndWFnZXMuXG4gICAqIFRoZSBzdWJzZXQgY2FuIGFsc28gYmUgc2V0IHdpdGggY29uZmlndXJlLCBidXQgdGhlIGxvY2FsIHBhcmFtZXRlciBvdmVycmlkZXMgdGhlIG9wdGlvbiBpZiBzZXQuXG4gICAqL1xuICBoaWdobGlnaHRFbGVtZW50KGNvZGU6IHN0cmluZywgbGFuZ3VhZ2VzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIC8vIFNldCBjb2RlIHRleHQgYmVmb3JlIGhpZ2hsaWdodGluZ1xuICAgIHRoaXMuc2V0VGV4dENvbnRlbnQoY29kZSk7XG4gICAgdGhpcy5faGxqcy5oaWdobGlnaHRBdXRvKGNvZGUsIGxhbmd1YWdlcykuc3Vic2NyaWJlKChyZXM6IGFueSkgPT4ge1xuICAgICAgLy8gU2V0IGhpZ2hsaWdodGVkIGNvZGVcbiAgICAgIHRoaXMuc2V0SW5uZXJIVE1MKHJlcy52YWx1ZSk7XG4gICAgICAvLyBDaGVjayBpZiB1c2VyIHdhbnQgdG8gc2hvdyBsaW5lIG51bWJlcnNcbiAgICAgIGlmICh0aGlzLmxpbmVOdW1iZXJzICYmIHRoaXMuX29wdGlvbnMgJiYgdGhpcy5fb3B0aW9ucy5saW5lTnVtYmVyc0xvYWRlcikge1xuICAgICAgICB0aGlzLmFkZExpbmVOdW1iZXJzKCk7XG4gICAgICB9XG4gICAgICAvLyBGb3J3YXJkIGhpZ2hsaWdodCByZXNwb25zZSB0byB0aGUgaGlnaGxpZ2h0ZWQgb3V0cHV0XG4gICAgICB0aGlzLmhpZ2hsaWdodGVkLmVtaXQocmVzKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkTGluZU51bWJlcnMoKSB7XG4gICAgLy8gQ2xlYW4gdXAgbGluZSBudW1iZXJzIG9ic2VydmVyXG4gICAgdGhpcy5kZXN0cm95TGluZU51bWJlcnNPYnNlcnZlcigpO1xuICAgIGFuaW1hdGlvbkZyYW1lU2NoZWR1bGVyLnNjaGVkdWxlKCgpID0+IHtcbiAgICAgIC8vIEFkZCBsaW5lIG51bWJlcnNcbiAgICAgIHRoaXMuX2hsanMubGluZU51bWJlcnNCbG9jayh0aGlzLl9uYXRpdmVFbGVtZW50KS5zdWJzY3JpYmUoKTtcbiAgICAgIC8vIElmIGxpbmVzIGNvdW50IGlzIDEsIHRoZSBsaW5lIG51bWJlcnMgbGlicmFyeSB3aWxsIG5vdCBhZGQgbnVtYmVyc1xuICAgICAgLy8gT2JzZXJ2ZSBjaGFuZ2VzIHRvIGFkZCAnaGxqcy1saW5lLW51bWJlcnMnIGNsYXNzIG9ubHkgd2hlbiBsaW5lIG51bWJlcnMgaXMgYWRkZWQgdG8gdGhlIGNvZGUgZWxlbWVudFxuICAgICAgdGhpcy5fbGluZU51bWJlcnNPYnMgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLl9uYXRpdmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkICYmIHRoaXMuX25hdGl2ZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnVEFCTEUnKSB7XG4gICAgICAgICAgdGhpcy5fbmF0aXZlRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdobGpzLWxpbmUtbnVtYmVycycpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGVzdHJveUxpbmVOdW1iZXJzT2JzZXJ2ZXIoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5fbGluZU51bWJlcnNPYnMub2JzZXJ2ZSh0aGlzLl9uYXRpdmVFbGVtZW50LCB7IGNoaWxkTGlzdDogdHJ1ZSB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZGVzdHJveUxpbmVOdW1iZXJzT2JzZXJ2ZXIoKSB7XG4gICAgaWYgKHRoaXMuX2xpbmVOdW1iZXJzT2JzKSB7XG4gICAgICB0aGlzLl9saW5lTnVtYmVyc09icy5kaXNjb25uZWN0KCk7XG4gICAgICB0aGlzLl9saW5lTnVtYmVyc09icyA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRUZXh0Q29udGVudChjb250ZW50OiBzdHJpbmcpIHtcbiAgICBhbmltYXRpb25GcmFtZVNjaGVkdWxlci5zY2hlZHVsZSgoKSA9PlxuICAgICAgdGhpcy5fbmF0aXZlRWxlbWVudC50ZXh0Q29udGVudCA9IGNvbnRlbnRcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRJbm5lckhUTUwoY29udGVudDogc3RyaW5nKSB7XG4gICAgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIuc2NoZWR1bGUoKCkgPT5cbiAgICAgIHRoaXMuX25hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MID0gdGhpcy5fc2FuaXRpemVyLnNhbml0aXplKFNlY3VyaXR5Q29udGV4dC5IVE1MLCBjb250ZW50KSB8fCAnJ1xuICAgICk7XG4gIH1cbn1cbiJdfQ==